apiVersion: tekton.dev/v1beta1
kind: Pipeline
metadata:
  name: hello-world-microservice-pipeline
  namespace: tekton-pipelines
spec:
  params:
    - name: gitrevision
    - name: gitrepositoryurl
    - name: image-url
    - name: image-tag
    - name: deployment-name
    - name: namespace
  tasks:
    - name: build-and-push
      taskRef:
        name: build-and-push
      params:
        - name: git-url
          value: "$(params.gitrepositoryurl)"
        - name: image-url
          value: "$(params.image-url)"
      podTemplate:
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
              - ALL
    - name: update-deployment
      taskRef:
        name: update-deployment
      runAfter:
        - build-and-push
      params:
        - name: deployment
          value: "$(params.deployment-name)"
        - name: image
          value: "$(params.image-url):$(params.image-tag)"
        - name: namespace
          value: "$(params.namespace)"
      podTemplate:
        securityContext:
          runAsNonRoot: true
          allowPrivilegeEscalation: false
          seccompProfile:
            type: RuntimeDefault
          capabilities:
            drop:
              - ALL